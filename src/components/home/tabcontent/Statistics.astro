---
import { ENV } from "../../../config/env";

// Fetch statistics on build.
let archiveStats;
try {
  const res = await fetch(
    `${ENV.COMMON_REST_ENDPOINT}/api/v2/statistics/archive`
  );
  if (!res.ok) throw new Error(`Archive API error: ${res.status}`);
  archiveStats = await res.json();
} catch (err) {
  console.error("Failed to fetch archive statistics, using fallback:", err);
  archiveStats = {};
}

let exploreStats;
try {
  const res = await fetch(
    `${ENV.COMMON_REST_ENDPOINT}/api/v2/statistics/explore`
  );
  if (!res.ok) throw new Error(`Explore API error: ${res.status}`);
  exploreStats = await res.json();
} catch (err) {
  console.error("Failed to fetch explore statistics, using fallback:", err);
  exploreStats = {};
}

// Helper for safely formatting numbers
const formatNumber = (n: number | undefined | null) =>
  n?.toLocaleString("de-CH") ?? "N/A";

// Helper for formatting a date string
const formatDate = (dateStr?: string) => {
  const date = dateStr ? new Date(dateStr) : new Date();
  return (
    date.toLocaleString("default", { month: "short" }) +
    " " +
    date.getUTCDate() +
    ", " +
    date.getFullYear()
  );
};

const structureNumber = formatNumber(archiveStats?.data?.n_structures);
const dftStructureNumber = formatNumber(archiveStats?.data?.dft_structures);

const totalNodes = formatNumber(exploreStats?.data?.nodes);
const totalProcesses = formatNumber(exploreStats?.data?.total_processes);

const archiveDate = formatDate(archiveStats?.data?.time_interval?.[1]);

const imageStyle = "w-full max-h-72 object-contain";
---

<div id="statistics" class="space-y-2 pb-6">
  <div class="space-y-6">
    <h3 class="text-center">Materials Cloud statistics</h3>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="text-center space-y-2">
        <h3 class="text-2xl font-bold">{structureNumber}</h3>
        <h4 class="text-base font-medium">crystal structures*</h4>
        <p class="text-gray-900">
          downloadable from the <br />
          <a href="https://archive.materialscloud.org/"
            >Materials Cloud Archive</a
          >
        </p>
      </div>
      <div class="text-center space-y-2">
        <h3 class="text-2xl font-bold">{dftStructureNumber}</h3>
        <h4 class="text-base font-medium">structures</h4>
        <p class="text-gray-900">
          in the
          <a href="https://archive.materialscloud.org/"
            >Materials Cloud Archive</a
          ><br />
          with associated DFT SCF calculations
        </p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="text-center space-y-2">
        <h3 class="text-2xl font-bold">{totalNodes}</h3>
        <h4 class="text-base font-medium">data and calculation nodes</h4>
        <p class="text-gray-900">
          in the
          <a href="https://materialscloud.org/explore/menu">Explore section</a
          >,<br />
          with full AiiDA provenance
        </p>
      </div>
      <div class="text-center space-y-2">
        <h3 class="text-2xl font-bold">{totalProcesses}</h3>
        <h4 class="text-base font-medium">reproducible calculations</h4>
        <p class="text-gray-900">
          in the
          <a href="https://materialscloud.org/explore/menu">Explore section</a
          >,<br />
          with full AiiDA provenance
        </p>
      </div>
    </div>

    <p class="text-gray-600 text-sm leading-relaxed text-center">
      Results based on records published on Materials Cloud Archive before {
        archiveDate
      }<br />
      *Structures counted with an automated script, no check for duplicates has been
      performed
    </p>

    <div class="text-center space-y-2 pt-5">
      <h4 class="text-lg font-medium">
        Number of unique page visits per month and per country<br />
        (last update Oct 10, 2025)
      </h4>
      <h6 class="text-sm text-gray-600">
        Materials Cloud uses <a
          href="https://plausible.io/data-policy"
          target="_blank">Plausible</a
        >
        to count its pages views without tracking users or storing cookies.
      </h6>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 px-2 gap-x-4">
      <div class="flex flex-col items-center">
        <span class="mb-4 text-center text-lg text-gray-700">
          Materials Cloud all
        </span>
        <img
          class={imageStyle}
          src="images/plausible/mc_all_barchart_10_10_2025.png"
          alt="Monthly visits"
        />
      </div>

      <div class="flex flex-col items-center">
        <span class="mb-4 text-center text-lg text-gray-700">
          Materials Cloud all
        </span>
        <img
          class={imageStyle}
          src="images/plausible/mc_all_pie_10_10_2025.png"
          alt="Visits by country"
        />
      </div>

      <div class="flex flex-col items-center">
        <span class="mb-4 text-center text-lg text-gray-700">
          Materials Cloud archive
        </span>
        <img
          class={imageStyle}
          src="images/plausible/mc_archive_barchart_10_10_2025.png"
          alt="Archive monthly visits"
        />
      </div>

      <div class="flex flex-col items-center">
        <span class="mb-4 text-center text-lg text-gray-700">
          Materials Cloud archive
        </span>
        <img
          class={imageStyle}
          src="images/plausible/mc_archive_pie_10_10_2025.png"
          alt="Archive visits by country"
        />
      </div>
    </div>
  </div>
</div>
