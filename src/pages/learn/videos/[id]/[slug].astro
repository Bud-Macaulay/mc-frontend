---
import Layout from "@layouts/Layout.astro";

import fs from "fs";
import path from "path";

const MANIFEST_FILE = path.resolve("./src/data/learn-manifest.json");
const manifest = JSON.parse(fs.readFileSync(MANIFEST_FILE, "utf-8"));

export async function getStaticPaths() {
  const MANIFEST_FILE = path.resolve("./src/data/learn-manifest.json");
  const manifest = JSON.parse(fs.readFileSync(MANIFEST_FILE, "utf-8"));

  const paths = manifest
    .filter((item) => item.type === "video")
    .map((item) => ({
      params: { id: item.id, slug: item.slug },
    }));

  return paths;
}

const { id } = Astro.params;

const video = manifest.find((item) => item.id === id);
if (!video) throw new Error(`Video not found: ${id}`);

const breadcrumbs = [
  { name: "Home", href: "." },
  { name: "Learn", href: "learn" },
];

let current = video;
const parentTrail = [];

// walk up parent chain
while (current.parentId) {
  const parent = manifest.find((item) => item.id === current.parentId);
  if (!parent) break;

  parentTrail.unshift({
    name: parent.title,
    href: `learn/sections/${parent.id}/${parent.slug}`,
  });

  current = parent;
}

// add the parent trail
breadcrumbs.push(...parentTrail);

// current video breadcrumb
breadcrumbs.push({
  name: video.title,
  href: `/learn/videos/${video.id}/${video.slug}`,
});
---

<Layout title={id} breadcrumbs={breadcrumbs}>
  <div class="space-y-10">
    <section class="space-y-4">
      <h3 class="text-2xl">{video.title}</h3>
      <hr class="border-t border-gray-300 mb-6" />
    </section>
  </div>

  <p>{video.description}</p>
  <div class="entry-description mt-2">
    Date:{" "}
    {
      new Date(video.date).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      })
    }{" "}
  </div><p>
    {
      video.speakers && video.speakers.length > 0 && (
        <div class="video-author mt-2">
          {video.speakers.map((speaker, index) => (
            <>
              <span>
                {speaker.title ? speaker.title + " " : ""}
                {speaker.first_name} {speaker.last_name}
                {index < video.speakers.length - 1 ? ", " : ""}
              </span>
              <a
                href={video.profile_url}
                target="_blank"
                rel="noopener noreferrer"
              >
                Event Profile
              </a>
            </>
          ))}
        </div>
      )
    }
  </p>

  {
    video.video_source_id && (
      <section class="pt-4 border-t border-gray-300 mb-6 mt-4 flex flex-col items-center text-center">
        {video.vidType === "slideshot" ? (
          <iframe
            width="900"
            height="1050"
            src={`https://slideshot.epfl.ch/eplay/${video.video_source_id}`}
            title={video.title}
            frameborder="0"
            allowfullscreen
          />
        ) : (
          <iframe
            width="800"
            height="450"
            src={`https://www.youtube.com/embed/${video.video_source_id}`}
            title={video.title}
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          />
        )}
      </section>
    )
  }

  {
    video.video_source_id && (
      <section class="pt-4 border-t border-gray-300 mb-6 mt-4 flex flex-col items-center text-center">
        <a
          rel="license"
          href="http://creativecommons.org/licenses/by-sa/4.0/"
          target="_blank"
        >
          <img alt="Creative Commons License" src="images/cc_by_sa.png" />
        </a>

        <p class="mt-2">
          This video is hosted on
          <a
            target="_blank"
            href={
              video.vidType === "slideshot"
                ? "https://slideshot.io"
                : "https://www.youtube.com/@MaterialsCloud"
            }
            class="underline"
          >
            {video.vidType === "slideshot" ? "Slideshot" : "YouTube"}
          </a>
          and is released under the
          <a
            href="https://creativecommons.org/licenses/by-sa/4.0/"
            target="_blank"
            class="underline"
          >
            Creative Commons Attribution-ShareAlike 4.0
          </a>{" "}
          license.
        </p>
      </section>
    )
  }
</Layout>
