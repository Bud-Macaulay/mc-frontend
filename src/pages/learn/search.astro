---
// populate search entries on /learn/search via a div container and a
// singular listener js script.

// very messy and formatting is hard coded / missing important things:
// no WATCH button;

import Layout from "@layouts/Layout.astro";
---

<Layout
  title="Search Results"
  breadcrumbs={[
    { name: "Home", href: "" },
    { name: "Learn", href: "learn" },
    { name: "Search", href: "#" },
  ]}
>
  <section class="flex items-center justify-between mb-6">
    <h3 class="text-2xl">Search results</h3>

    <a href="learn" class="explore-button"> Go Back </a>
  </section>
  <hr class="border-t border-gray-300 mb-6" />

  <div id="searchContainer" class="entries-container">
    {
      Array.from({ length: 20 }).map(() => (
        <div class="entry-container opacity-0">
          {/* Media Section */}
          <div class="flex flex-col items-center w-48 entry-flex">
            <a href="#">
              <img
                src="images/placeholder.png"
                alt=""
                class="entry-image max-w-48 max-h-48 w-auto h-auto object-cover"
              />
              <div class="hidden items-center justify-center w-48 h-48 bg-gray-100 rounded" />
            </a>

            <a href="#" class="explore-button mt-2 flex items-center hidden" />
          </div>

          <div class="entry-info-container">
            <a href="#" class="entry-title hover:underline" />
            <div class="entry-author italic ml-2" />
            <hr class="border-t border-gray-200 mb-2" />

            {/* Date */}
            <div class="entry-date pl-1 text-gray-500 pl-1">
              Date: <span />
            </div>

            {/* Description */}
            <div class="entry-description pl-1">
              <b>Description:</b> <span />
            </div>

            {/* Additional description section (like in videos) */}
            <div class="entry-description pt-1 pl-1">
              <span />
            </div>

            {/* Additional resources */}
            <div class="entry-description pt-1 pl-2 flex items-center space-x-4 entry-additional-resources" />
          </div>
        </div>
      ))
    }
  </div>

  <script type="module">
    import { search, data } from "/src/components/search.js";

    window.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("searchContainer");
      const placeholders = container.querySelectorAll(".entry-container");

      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get("query") || "";
      const results = query ? search(data, query) : data;

      results.forEach((entry, i) => {
        if (i >= placeholders.length) return;
        const el = placeholders[i];

        // Determine href based on type
        let href = "#";
        if (entry.type === "video") {
          href = `learn/videos/${entry.id}/${entry.slug}`;
        } else {
          href = `learn/sections/${entry.id}/${entry.slug}`;
        }

        // Set link & thumbnail
        const link = el.querySelector(".entry-flex a");
        if (link) link.href = href;

        const img = el.querySelector(".entry-flex img");
        if (img) {
          img.src = entry.thumbnail_url
            ? `/images/learn/${entry.thumbnail_url}`
            : "images/placeholder.png";
          img.alt = entry.title || "";
        }

        // Title link
        const titleLink = el.querySelector(".entry-title");
        if (titleLink) {
          titleLink.textContent = entry.title || "";
          titleLink.href = href;
        }

        // Description
        const desc = el.querySelector(".entry-description span");
        if (desc) desc.innerHTML = entry.description || "";

        // Description
        const date = el.querySelector(".entry-date span");
        if (date) date.innerHTML = entry.date || "";

        // Authors / speakers
        const authorDiv = el.querySelector(".entry-author");
        if (authorDiv && entry.speakers) {
          authorDiv.textContent = entry.speakers
            .map((s) => `${s.title || ""} ${s.first_name} ${s.last_name}`)
            .join(", ");
        }

        // Additional resources
        const resDiv = el.querySelector(".entry-additional-resources");
        if (resDiv && entry.additional_resources) {
          resDiv.innerHTML = "";
          entry.additional_resources.forEach((r) => {
            const a = document.createElement("a");
            a.href = `https://rgw.cscs.ch/matcloud:mc-public/learn-data/files/${entry.id}/${r.url}`;
            a.download = "";
            a.textContent = r.name;
            a.className = "hover:underline";
            resDiv.appendChild(a);
          });
        }

        el.style.opacity = 1;
      });

      // Hide unused placeholders
      for (let i = results.length; i < placeholders.length; i++) {
        placeholders[i].style.display = "none";
      }
    });
  </script>
</Layout>
